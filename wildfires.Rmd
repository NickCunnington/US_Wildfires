---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(RSQLite)
library(dbplyr)
library(janitor)
library(lubridate)
library(datasets)
library(ggthemes)
```

```{r}
# create db connection
conn <- dbConnect(SQLite(), 'raw_data/FPA_FOD_20170508.sqlite')

# pull the fires table into RAM
fires <- tbl(conn, "Fires") %>% collect()

# check size
print(object.size(fires), units = 'Gb')
```

```{r}
dbDisconnect(conn)
```

```{r}
as.data.frame(dbListTables(conn))
```


```{r}
fires_small <- fires %>%
  select(NWCG_REPORTING_AGENCY, SOURCE_REPORTING_UNIT_NAME, FIRE_CODE, FIRE_NAME,
         FIRE_YEAR, DISCOVERY_DATE, DISCOVERY_DOY, DISCOVERY_TIME, CONT_DATE,
         CONT_DOY, CONT_TIME, STAT_CAUSE_CODE, STAT_CAUSE_DESCR, FIRE_SIZE, 
         FIRE_SIZE_CLASS, LATITUDE, LONGITUDE, OWNER_CODE, OWNER_DESCR, STATE, 
         COUNTY, FIPS_CODE, FIPS_NAME, Shape)

fires_small <- clean_names(fires_small)
```

```{r}
str(fires_small)
```


```{r}
fires_small <- fires_small %>%
  mutate(nwcg_reporting_agency = as.factor(nwcg_reporting_agency)) %>%
  mutate(stat_cause_code = as.factor(stat_cause_code)) %>%
  mutate(fire_size_class = as.factor(fire_size_class)) %>%
  mutate(owner_descr = as.factor(owner_descr)) %>%
  mutate(state = as.factor(state)) 
```


```{r}
fires_small <- fires_small %>%
  mutate(cont_date = as.Date(cont_date - 2458014.5, origin = "2017-09-18")) %>%
  mutate(discovery_date = as.Date(discovery_date - 2458014.5, origin = "2017-09-18"))
```



# visualisations

## fires per year

```{r}
fires_small %>%
  group_by(fire_year) %>%
  summarise(num_fires =n()) %>%
  ggplot(aes(x = fire_year, y = num_fires)) +
  geom_col(fill = "dark blue", col ="white")
```

## fire per day

```{r}
fires_small %>%
  group_by(discovery_date) %>%
  summarise(num_fires = n()) %>%
  ggplot(aes(x = discovery_date, y = num_fires)) +
  geom_line(col = "dark blue")

```


## fire per month

```{r}
fires_small %>%
  mutate(month = month(discovery_date)) %>%
  group_by(fire_year, month) %>%
  summarise(num_fires = n()) %>%
  mutate(year_month = make_date(fire_year, month)) %>%
  ggplot(aes(x = year_month, y = num_fires)) +
  geom_line(col = "dark blue")
```


## fires by day of year


```{r}
fires_small %>%
  group_by(discovery_doy) %>%
  summarise(num_fires = n()) %>%
  ggplot(aes(x = discovery_doy, y = num_fires)) +
  geom_line(col = "dark blue")
```


## fires by cause

```{r}
fires_small %>%
  group_by(stat_cause_descr) %>%
  summarise(num_fires = n()) %>%
  ggplot(aes(reorder(x = stat_cause_descr, num_fires), y = num_fires)) +
  geom_col(fill = "dark blue") + 
  coord_flip()
```


## fire avg size by cause

```{r}
fires_small %>%
  group_by(stat_cause_descr) %>%
  summarise(avg_size = mean(fire_size)) %>%
  ggplot(aes(reorder(x = stat_cause_descr, avg_size), y = avg_size)) +
  geom_col(fill = "dark blue") + 
  coord_flip()
```


## av burn time by cause

(891531 NAs)

```{r}
fires_small %>%
  group_by(stat_cause_descr) %>%
  summarise(burn_time = mean((cont_date - discovery_date), na.rm = TRUE)) %>%
  ggplot(aes(reorder(x = stat_cause_descr, burn_time), y = burn_time)) +
  geom_col(fill = "dark blue")
```

## fires by size

(change x-axis to show numbers not letter)

```{r}
fires_small %>%
  group_by(fire_size_class) %>%
  summarise(num_fires = n()) %>%
  ggplot(aes(reorder(x = fire_size_class, num_fires), y = num_fires, fill = fire_size_class)) +
  geom_col() +
  coord_flip()
```




```{r}
state_list <- tibble(state = state.abb, region = tolower(state.name))
state_list
```

state_list is 50 rows, but the state column from fires_small has 52.

```{r}
length(unique(fires_small$state))
```

Make a new data frame with the state column from fires_small

```{r}
fire_states <- as.data.frame(unique(fires_small$state))
names(fire_states)[1] <- "state"
```

Join to the state_list

```{r}
fire_states_list <- full_join(state_list, fire_states)
```

Find missing states

```{r}
fire_states_list %>%
  filter(is.na(region))
  
```

Adding DC and PR to fires_small and check for 52 entries

```{r}
state.abb <- append(state.abb, c("DC", "PR"))
state.name <- append(state.name, c("District of Columbia", "Puerto Rico"))

state_list <- tibble(state = state.abb, region = tolower(state.name))

nrow(state_list)
```


```{r}
fires_small <- fires_small %>%
  left_join(state_list, by = "state")
```


```{r}
state_map <- map_data("state")
```


```{r}
fires_small %>% 
    select(region) %>%
    group_by(region) %>%
    summarise(num_fires = n()) %>%
    right_join(state_map, by = "region") %>%
    ggplot +
    (aes(x = long, y = lat, group = group, fill = num_fires)) + 
    geom_polygon() + 
    geom_path(color = 'white') + 
    scale_fill_continuous(low = "darkblue", 
                          high = "darkred",
                          name = "Number of fires") + 
    theme_map() + 
    coord_map("mollweide") + 
    ggtitle("US Wildfires, 1992-2015") + 
    theme(plot.title = element_text(hjust = 0.5))
```




```{r}
rm(state.abb)
rm(state.name)
```


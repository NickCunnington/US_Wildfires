---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(RSQLite)
library(dbplyr)
library(janitor)
library(lubridate)
library(datasets)
library(ggthemes)
```


# 1.  Data Cleaning


####  Creating connection to the sqlite database and downloading fires dataset

```{r}
# Connecting

conn <- dbConnect(SQLite(), 'raw_data/FPA_FOD_20170508.sqlite')
```

```{r}
# Pulling all the names of the tables in the database file

as.data.frame(dbListTables(conn))
```

```{r}
# Making fires dataframe

fires <- tbl(conn, "Fires") %>% collect()
```


#### Seeing what other useful information is in the database.  The majority are part of the database structure and are not readable in R.

```{r}
# EPSG worldwide geodetic parameter dataset system
spatial_ref <- tbl(conn, "spatial_ref_sys_all") %>% collect()

# National Wildfire Coordinating Group unit abbreviations 
NWGG <- tbl(conn, "NWCG_UnitIDActive_20170109") %>% collect()
```


```{r}
# Disconnect

dbDisconnect(conn)
```


### Selecting columns of interest

```{r}
fires_small <- fires %>%
  select(NWCG_REPORTING_AGENCY, SOURCE_REPORTING_UNIT_NAME, FIRE_NAME,
         FIRE_YEAR, DISCOVERY_DATE, DISCOVERY_DOY, DISCOVERY_TIME, CONT_DATE,
         CONT_DOY, CONT_TIME, STAT_CAUSE_CODE, STAT_CAUSE_DESCR, FIRE_SIZE, 
         FIRE_SIZE_CLASS, LATITUDE, LONGITUDE, OWNER_CODE, OWNER_DESCR, STATE, 
         COUNTY, FIPS_CODE, FIPS_NAME, Shape)

fires_small <- clean_names(fires_small)
```


### Changing some columms to be factors

```{r}
fires_small <- fires_small %>%
  mutate(nwcg_reporting_agency = as.factor(nwcg_reporting_agency)) %>%
  mutate(stat_cause_code = as.factor(stat_cause_code)) %>%
  mutate(fire_size_class = as.factor(fire_size_class)) %>%
  mutate(owner_descr = as.factor(owner_descr)) %>%
  mutate(state = as.factor(state)) 
```


### Date is in Julian format, so overwriting with Gregorian format using year and day of year columns.  Also adding in a 'month of year column' for future use.

```{r}
fires_small <- fires_small %>%
  mutate(date_origin = as.Date(paste0(fire_year, "-01-01"))) %>%
  mutate(discovery_date = as.Date(discovery_doy, origin = date_origin)) %>%
  mutate(discovery_moy = month(discovery_date)) %>%
  select(-date_origin)
```



# 2. Creating some initial visualisations


### Fires per year

```{r}
fires_small %>%
  group_by(fire_year) %>%
  summarise(num_fires =n()) %>%
  ggplot +
  aes(x = fire_year, y = num_fires) +
  geom_point() +
  # geom_col(fill = "dark blue", col ="white") +
  geom_smooth(method = 'lm', se = FALSE, colour = "red")
```
**It can be seen from the linear modelling smoother that there is a slight increase of wildfire over the recording period, but there is a lot of variation in the data between years.  There is almost a repeating pattern occuring with 4 peaks visible.  Having looked at the historic weather for that date range these peaks seems to coincide with recorded heatwaves in 2000, 2006 and 2011.**


### Fires per day

```{r}
fires_small %>%
  group_by(discovery_date) %>%
  summarise(num_fires = n()) %>%
  ggplot +
  aes(x = discovery_date, y = num_fires) +
  geom_line(col = "dark blue")

```

**This shows a typical time series plot with a cyclic variation due to warmer weather in the summer time.**


### Fires per month

```{r}
fires_small %>%
  mutate(year_month = make_date(fire_year, discovery_moy)) %>%
  group_by(year_month) %>%
  summarise(num_fires = n()) %>%
  ggplot +
  aes(x = year_month, y = num_fires) +
  geom_line(col = "dark blue")
```

**Peaks are still shown to be occurring in the summer. The 2006 heatwave is especially visable.**


### Fires by day of year


```{r}
fires_small %>%
  group_by(discovery_doy) %>%
  summarise(num_fires = n()) %>%
  ggplot(aes(x = discovery_doy, y = num_fires)) +
  geom_line(col = "dark blue")
```

**The are peaks around day 60-110 and a big peak around 180.**

#### Checking the data to see where the peak occurs

```{r}
fires_small %>%
  group_by(discovery_doy) %>%
  summarise(num_fires = n()) %>%
  arrange(desc(num_fires))
```
**The 2 highest days of the year are on 185 and 186, which happens to be Independence Day (4th July) on a normal year and a leap year retrospectively.  So I imagine most of the extra fires (literally over double the normal amount) are caused by fireworks.**



### Fires by month of year

```{r}
fires_small %>%
  mutate(discovery_moy = (month(ymd(discovery_date), label = TRUE))) %>%
  group_by(discovery_moy) %>%
  summarise(num_fires = n()) %>%
  ggplot(aes(x = discovery_moy, y = num_fires)) +
  geom_col(fill = "dark blue", col = "white")
```

**There are 2 definite peaks during the year.  March and April are probably due to the US "Spring Break", where schools and Universities are stopped and so families are likely to be on vacation during that period possibly visiting National Parks.  July and August is also Summer Break for school with both families visiting Parks and hot weather likey causes of fire outbreaks.**




### Fires by cause

```{r}
options(scipen = 999)

fires_small %>%
  group_by(stat_cause_descr) %>%
  summarise(num_fires = n()) %>%
  ggplot +
  aes(reorder(x = stat_cause_descr, num_fires), y = num_fires) +
  geom_col(fill = "dark blue") + 
  coord_flip() 
```


### Fire avg size by cause

```{r}
fires_small %>%
  group_by(stat_cause_descr) %>%
  summarise(avg_size = mean(fire_size)) %>%
  ggplot +
  aes(reorder(x = stat_cause_descr, avg_size), y = avg_size) +
  geom_col(fill = "dark blue") + 
  coord_flip()
```


### Avg burn time by cause

```{r}
fires_small %>%
  summarise(num_na = sum(is.na(cont_date)))
```
*Literally half the data is missing for burn time, making it very difficult to do any meaningful analysis*



### Fires by size


```{r}
fires_small %>%
  group_by(fire_size_class) %>%
  summarise(num_fires = n()) %>%
  ggplot +
  aes(x = fire_size_class, y = num_fires, fill = fire_size_class) +
  geom_col() +
  scale_fill_manual(values = c("red", "orange", "yellow", "green", "blue", 
                               "purple", "black"),
                    name = "Fire Size Classification",
                    breaks = c("A", "B", "C", "D", "E", "F", "G"),
                    labels = c("A: < 1/4 acre", "B: 1/4 to 10 acres", "C: 10 to 100 acres",
                               "D: 100 to 300 acres", "E: 300 to 1000 acres",
                               "F: 1000 to 5000 acres", "G: More than 5000 acres"))

```



# Geo Spatial wrangling 


### To make it easier to visually detect frequency of wildfires between states I want display it in a map format.  As I'm using ggplot2 already I'm going to also use it for maps with the `geom_polygon()`, `coord_map()` along with the ggthemes `theme_map()` functions.


#### I'm not entirely sure what geo-spatial information is being held with in the sqlite database file, I've made a few attempts to retrieve it but have been unsuccessful.  Therefore I'm going to utelise the `datasets` package which includes various bits of information on the US States, including coordinates for state boundaries.


```{r}
# State boundary co-ordinates from 'datasets' package

state_map <- map_data("state")
state_map
```


#### Annoyingly it doesn't have the abbreviation of the State, only the full name so I need to add that in.  Luckily the 'datasets' package also has a vector of States names and abbreviations so I shall make a tibble with them both in.


```{r}
state.abb
```

```{r}
state.name
```

```{r}
state_list <- tibble(state = state.abb, state_name = state.name)
state_list
```


#### The `state_map` dataframe is in lower case and has the column name 'region'.  I shall change the `state_list` tibble to be the same format so they can be joined together.


```{r}
state_list <- tibble(state = state.abb, region = tolower(state.name))
```


#### Joing `state_list` to `fires_small` datasets

```{r}
fires_states <- fires_small %>%
  left_join(state_list, by = "state")

fires_states
```


#### Checking the join has worked and there are no missing values.

```{r}
fires_states %>%
  filter(is.na(region))
```


#### There does seem to be 22,147 NAs in the 'region' column we just made.  Scrolling through there are 2 missing States of 'PR' and 'DC' in the `states_list` tibble.

#### After some quick research it seems that there are only 50 States in the US. Washington DC is techincally not counted as a state but as a Federal District, as it is the seat of government, so that was why it wasn't included in the `States` tibble originally.  PR is Puerto Rico and is also not a state but the largest US territory .


#### I shall add DC and PR into the state_list and re-join it.

```{r}
# Adding 2 new states

state.abb <- append(state.abb, c("DC", "PR"))
state.name <- append(state.name, c("District of Columbia", "Puerto Rico"))

state_list <- tibble(state = state.abb, region = tolower(state.name))
```


```{r}
# Rejoing tibbles

fires_states <- fires_small %>%
  left_join(state_list, by = "state")
```


```{r}
# Checking the join has worked properly and there are no NAs

fires_states %>%
  filter(is.na(region))
```

```{r}
# Code below brings up a "vector memory exhausted (limit reached?)" error

# fires_joined <- fires_states %>%
#  right_join(state_map, by = "region")
```


#### The data set and geo information is too big to join so I'm going to do a summarise first to get the number of fires per region first.

```{r}
fires_joined <- fires_states %>% 
    select(region) %>%
    group_by(region) %>%
    summarise(num_fires = n()) %>%
    right_join(state_map, by = "region")
```

**Result!!  Now doing first geo spatial visualisation**


### Total Wildfires per state from 1992-2015

```{r}
fires_joined %>% 
    ggplot +
    (aes(x = long, y = lat, group = group, fill = num_fires)) + 
    geom_polygon() + 
    geom_path(color = 'white') + 
    scale_fill_continuous(low = "darkblue", 
                          high = "darkred",
                          name = "Number of fires") + 
    theme_map() + 
    coord_map("mollweide") + 
    ggtitle("Total US Wildfires from 1992-2015") + 
    theme(plot.title = element_text(hjust = 0.5))
```


# 3. Geo Spatial Visualisations

### The dataset has a cause of fire column so I shall now create some causation plots.


#### Getting list of fire causes

```{r}
fires_states %>%
  distinct(stat_cause_descr) %>%
  arrange(-desc(stat_cause_descr))
```


### Total fire by cause in tabular form

```{r}
fires_states %>%
  select(stat_cause_descr) %>%
  group_by(stat_cause_descr) %>%
  summarise(num_fires = n ()) %>%
  arrange(desc(num_fires))
  
```

### Number of fires by state in tabular form

```{r}
fires_states %>%
  select(region) %>%
  group_by(region) %>%
  summarise(num_fires = n()) %>%
  arrange(desc(num_fires))
```


#### As the cause needs to be filtered before the map join, I'm going to either going to have to do it in every single plot or write a function that will do it for me with a lot less code in total.

```{r}
cause <- function(cause) {
  fires_states %>%
    filter(stat_cause_descr == cause) %>%
    select(region) %>%
    group_by(region) %>%
    summarise(num_fires = n ()) %>%
    right_join(state_map, by = "region") %>%
    ggplot +
    (aes(x = long, y = lat, group = group, fill = num_fires)) + 
    geom_polygon() + 
    geom_path(color = 'white') + 
    scale_fill_continuous(low = "darkblue", 
                          high = "darkred",
                          name = "Number of fires") + 
    theme_map() + 
    coord_map("mollweide") + 
    ggtitle(paste0("Total US Wildfires caused by ", cause, " from 1992-2015")) + 
    theme(plot.title = element_text(hjust = 0.5))
}
```



### Wildfires caused by Arson

```{r}
cause("Arson")
```

### Wildfires caused by Campfire

```{r}
cause("Campfire")
```

### Wildfires caused by Children

```{r}
cause("Children")
```

### Wildfires caused by Debris Burning

```{r}
cause("Debris Burning")
```

### Wildfires caused by Equiment Use

```{r}
cause("Equipment Use")
```

### Wildfires caused by Fireworks

```{r}
cause("Fireworks")
```

### Wildfires caused by Lightning

```{r}
cause("Lightning")
```

### Wildfires caused by Miscellious

```{r}
cause("Miscellaneous")
```

### Wildfires caused by Missing/Undefined

```{r}
cause("Missing/Undefined")
```

### Wildfires caused by Powerline

```{r}
cause("Powerline")
```

### Wildfires caused by Railroad

```{r}
cause("Railroad")
```

### Wildfires caused by Smoking

```{r}
cause("Smoking")
```

### Wildfires caused by Structure

```{r}
cause("Structure")
```


#### Unsurprisingly the southern states seem to have more occurences of wildifre in general, no doubt due to the warmer climate at their latitudes.  Also the 1st and 3rd states with the highest number of fires are also the 2 largest States by size. However the 2nd highest State is Georgia, which although in the South of the country is an average sized State.  Therefore to get a better picture of what is going on I'm going to look at the proportion of fires occuring by square mile by normalising the State size.

#### The `dataset` package also has the area in square miles of each state included in the `state.area` vector.

```{r}
state.area
```

```{r}
length(state.area)
```

#### Annoyingly it also only has 50 states not 52 so I will need to add in DC and PR.  

(Area figures obtained from Wikipedia)
DC = 68 miles^2
PR = 3515 miles^2


```{r}
# To make my life easier I'm going to remove the state.abb and .name files and make the tibble again, adding in the land area figures at the same time to make sure they are in the correct order.

rm(state.abb)
rm(state.name)

state.abb <- append(state.abb, c("DC", "PR"))
state.name <- append(state.name, c("District of Columbia", "Puerto Rico"))
state.area <- append(state.area, c("68", "3515"))

state_list <- tibble(state = state.abb, region = tolower(state.name), area = as.numeric(state.area))
```

```{r}
# Re-joing tibbles

fires_states <- fires_small %>%
  left_join(state_list, by = "state")
```


### Normalising States area sizes

```{r}
fires_states %>%
  select(region, area) %>%
  group_by(region, area) %>%
  summarise(num_fires = n()) %>%
  mutate(fires_sqmile = num_fires / area) %>%
  arrange(desc(fires_sqmile))
```

#### This table shows Puerto Rico has the highest proportion of fires compared to its size, followed by New Jersey in the NE of the country and finally by the States in the SE of the country.


```{r}
fires_states %>%
  select(region, area) %>%
  group_by(region, area) %>%
  summarise(num_fires = n()) %>%
  mutate(fires_sqmile = num_fires / area) %>%
  right_join(state_map, by = "region") %>%
  ggplot +
  (aes(x = long, y = lat, group = group, fill = fires_sqmile)) + 
  geom_polygon() + 
  geom_path(color = 'white') + 
  scale_fill_continuous(low = "darkblue", 
                        high = "darkred",
                        name = "Fire per Sq mile") + 
  theme_map() + 
  coord_map("mollweide") + 
  ggtitle(paste0("Total US Wildfires per Square Mile from 1992-2015")) + 
  theme(plot.title = element_text(hjust = 0.5))
````

#### Puerto Rico is not shown on this map, but visually we can see the data for the other 51 entries.


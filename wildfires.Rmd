---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(RSQLite)
library(dbplyr)
library(janitor)
library(lubridate)
library(datasets)
library(ggthemes)
```


# 1.  Data Cleaning


Creating connection to the sqlite database and downloading fires dataset

```{r}
conn <- dbConnect(SQLite(), 'raw_data/FPA_FOD_20170508.sqlite')

fires <- tbl(conn, "Fires") %>% collect()
```

```{r}
# pulling all the names of the tables in the database file

as.data.frame(dbListTables(conn))
```

```{r}
dbDisconnect(conn)
```


### Selecting columns of interest

```{r}
fires_small <- fires %>%
  select(NWCG_REPORTING_AGENCY, SOURCE_REPORTING_UNIT_NAME, FIRE_NAME,
         FIRE_YEAR, DISCOVERY_DATE, DISCOVERY_DOY, DISCOVERY_TIME, CONT_DATE,
         CONT_DOY, CONT_TIME, STAT_CAUSE_CODE, STAT_CAUSE_DESCR, FIRE_SIZE, 
         FIRE_SIZE_CLASS, LATITUDE, LONGITUDE, OWNER_CODE, OWNER_DESCR, STATE, 
         COUNTY, FIPS_CODE, FIPS_NAME, Shape)

fires_small <- clean_names(fires_small)
```


### Changing some columms to be factors

```{r}
fires_small <- fires_small %>%
  mutate(nwcg_reporting_agency = as.factor(nwcg_reporting_agency)) %>%
  mutate(stat_cause_code = as.factor(stat_cause_code)) %>%
  mutate(fire_size_class = as.factor(fire_size_class)) %>%
  mutate(owner_descr = as.factor(owner_descr)) %>%
  mutate(state = as.factor(state)) 
```


### Date is in Julian format, so overwriting with Gregorian format using year and day of year columns.  Also adding in a month of year column for future use.

```{r}
fires_small <- fires_small %>%
  mutate(date_origin = as.Date(paste0(fire_year, "-01-01"))) %>%
  mutate(discovery_date = as.Date(discovery_doy, origin = date_origin)) %>%
  mutate(discovery_moy = month(discovery_date)) %>%
  select(-date_origin)
```





# 2. Creating some visualisations


### fires per year

```{r}
fires_small %>%
  group_by(fire_year) %>%
  summarise(num_fires =n()) %>%
  ggplot +
  aes(x = fire_year, y = num_fires) +
  geom_col(fill = "dark blue", col ="white")
```


## fires per day

```{r}
fires_small %>%
  group_by(discovery_date) %>%
  summarise(num_fires = n()) %>%
  ggplot +
  aes(x = discovery_date, y = num_fires) +
  geom_line(col = "dark blue")

```


### fires per month

```{r}
fires_small %>%
  mutate(year_month = make_date(fire_year, discovery_moy)) %>%
  group_by(year_month) %>%
  summarise(num_fires = n()) %>%
  ggplot +
  aes(x = year_month, y = num_fires) +
  geom_line(col = "dark blue")
```


### fires by day of year


```{r}
fires_small %>%
  group_by(discovery_doy) %>%
  summarise(num_fires = n()) %>%
  ggplot(aes(x = discovery_doy, y = num_fires)) +
  geom_line(col = "dark blue")
```

*4th July? DOY: 185/186*


### fires by month of year

```{r}
fires_small %>%
  mutate(discovery_moy = (month(ymd(discovery_date), label = TRUE))) %>%
  group_by(discovery_moy) %>%
  summarise(num_fires = n()) %>%
  ggplot(aes(x = discovery_moy, y = num_fires)) +
  geom_col(fill = "dark blue", col = "white")
```

*why mar/apr peak?*




## fires by cause

```{r}
options(scipen = 999)

fires_small %>%
  group_by(stat_cause_descr) %>%
  summarise(num_fires = n()) %>%
  ggplot +
  aes(reorder(x = stat_cause_descr, num_fires), y = num_fires) +
  geom_col(fill = "dark blue") + 
  coord_flip() 
```


## fire avg size by cause

```{r}
fires_small %>%
  group_by(stat_cause_descr) %>%
  summarise(avg_size = mean(fire_size)) %>%
  ggplot +
  aes(reorder(x = stat_cause_descr, avg_size), y = avg_size) +
  geom_col(fill = "dark blue") + 
  coord_flip()
```


## av burn time by cause

```{r}
fires_small %>%
  summarise(num_na = sum(is.na(cont_date)))
```
*Literally half the data is missing for burn time, making it very difficult to do any meaningful analysis*



### fires by size


```{r}
fires_small %>%
  group_by(fire_size_class) %>%
  summarise(num_fires = n()) %>%
  ggplot +
  aes(x = fire_size_class, y = num_fires, fill = fire_size_class) +
  geom_col() +
  scale_fill_manual(values = c("red", "orange", "yellow", "green", "blue", 
                               "purple", "black"),
                    name = "Fire Size Classification",
                    breaks = c("A", "B", "C", "D", "E", "F", "G"),
                    labels = c("A: < 1/4 acre", "B: 1/4 to 10 acres", "C: 10 to 100 acres",
                               "D: 100 to 300 acres", "E: 300 to 1000 acres",
                               "F: 1000 to 5000 acres", "G: More than 5000 acres"))

```


# Geo Spatial Visualisations 





### To make meaningful use of information on fires per State we need to convert the State abbreviation into it's name we it can be plotted on a map.  Using the list of state abbreviation dataset included with base R.


```{r}
state_list <- tibble(state = state.abb, state_name = state.name)
state_list
```

state_list is 50 rows, but the state column from fires_small has 52.

```{r}
length(unique(fires_small$state))
```


*Sdgdg*

```{r}
state_list <- tibble(state = state.abb, region = tolower(state.name))
```



Make a new data frame with the state column from fires_small

```{r}
fire_states <- as.data.frame(unique(fires_small$state))
names(fire_states)[1] <- "state"
```

Join to the state_list

```{r}
fire_states_list <- full_join(state_list, fire_states)
```

Find missing states

```{r}
fire_states_list %>%
  filter(is.na(region))
  
```

Adding DC and PR to fires_small and check for 52 entries

```{r}
state.abb <- append(state.abb, c("DC", "PR"))
state.name <- append(state.name, c("District of Columbia", "Puerto Rico"))

state_list <- tibble(state = state.abb, region = tolower(state.name))

nrow(state_list)
```


```{r}
fires_small <- fires_small %>%
  left_join(state_list, by = "state")
```


```{r}
state_map <- map_data("state")
```


```{r}
fires_small %>% 
    select(region) %>%
    group_by(region) %>%
    summarise(num_fires = n()) %>%
    right_join(state_map, by = "region") %>%
    ggplot +
    (aes(x = long, y = lat, group = group, fill = num_fires)) + 
    geom_polygon() + 
    geom_path(color = 'white') + 
    scale_fill_continuous(low = "darkblue", 
                          high = "darkred",
                          name = "Number of fires") + 
    theme_map() + 
    coord_map("mollweide") + 
    ggtitle("US Wildfires, 1992-2015") + 
    theme(plot.title = element_text(hjust = 0.5))
```




```{r}
rm(state.abb)
rm(state.name)
```

